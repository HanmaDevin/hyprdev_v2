#!/usr/bin/env bash

if [ -f ~/.diashow-running ]; then
    notify-send "Diashow running, toggle it off" "Super + Alt + Space"
    exit 1
fi

# Ensure elephant is running before launching walker
if ! pgrep -x elephant >/dev/null; then
    elephant &
fi

# Ensure walker service is running
if ! pgrep -f "walker --gapplication-service" >/dev/null; then
    walker --gapplication-service &
fi

WALLPAPER_DIR="$HOME/Pictures/Wallpaper"
CURRENT_WALL=$(swww query | sed 's/.*image: //')

MENU=""
for wall in $(fd -E "$CURRENT_WALL" . "$WALLPAPER_DIR"); do
    MENU+="$(basename "$wall")\n"
done

selected=$(echo -e "$MENU" | hyprdev-launch-walker --minheight 1 --maxheight 700 -N -d -p "Select Wallpaper...")

if [ -z "$selected" ]; then
    exit 1
fi

if [[ ! "$selected" =~ .*?\.(jpg|png|jpeg) ]]; then
    notify-send "Hyprdev Wallpaper" "Invalid format"
    exit 1
fi

matugen image "$WALLPAPER_DIR/$selected"
cp "$WALLPAPER_DIR/$selected" ~/.current_wallpaper
