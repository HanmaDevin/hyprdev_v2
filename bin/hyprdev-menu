#!/usr/bin/env bash
# Copyright (c) David Heinemeier Hansson
#
# Permission is hereby granted, free of charge, to any person obtaining
# a copy of this software and associated documentation files (the
# "Software"), to deal in the Software without restriction, including
# without limitation the rights to use, copy, modify, merge, publish,
# distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so, subject to
# the following conditions:
#
# The above copyright notice and this permission notice shall be
# included in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
# NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
# LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
# WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

# Set to true when going directly to a submenu, so we can exit directly
BACK_TO_EXIT=false

back_to() {
  local parent_menu="$1"

  if [[ "$BACK_TO_EXIT" == "true" ]]; then
    exit 0
  elif [[ -n "$parent_menu" ]]; then
    "$parent_menu"
  else
    show_main_menu
  fi
}

terminal() {
  kitty --class "org.hyprdev.terminal" -e "$1"
}

show_capture_menu() {
  case $(hyprdev-rofi-screenrecord "  Screenshot\n  Screenrecord\n󰃉  Color") in
  *Screenshot*) hyprdev-screenshot-with-edit ;;
  *Screenrecord*) show_screenrecord_menu ;;
  *Color*) pkill hyprpicker || hyprpicker -a ;;
  *) show_trigger_menu ;;
  esac
}

open_in_editor() {
  notify-send "Editing config file" "$1"
  kitty -e nvim "$1"
}

show_screenrecord_menu() {
  hyprdev-screenrecord --stop-recording && exit 0

  case $(hyprdev-rofi-screenrecord "  With desktop audio\n  With desktop + microphone audio\n  With desktop + microphone audio + webcam" "--minwidth 1 --maxwidth 700") in
  *"With desktop audio") hyprdev-screenrecord --with-desktop-audio ;;
  *"With desktop + microphone audio") hyprdev-screenrecord --with-desktop-audio --with-microphone-audio ;;
  *"With desktop + microphone audio + webcam") hyprdev-screenrecord --with-desktop-audio --with-microphone-audio --with-webcam ;;
  *) back_to show_capture_menu ;;
  esac
}

show_trigger_menu() {
  case $(hyprdev-rofi-menu "  Capture") in
  *Capture*) show_capture_menu ;;
  *) show_main_menu ;;
  esac
}

show_install_menu() {
  terminal hyprdev-pkg-install
}

show_setup_menu() {
  local options="  Audio\n  Wifi\n󰂯  Bluetooth\n󰍹  Monitors\n󰸉  Wallpaper"
  [ -f ~/.config/hypr/keybinds.conf ] && options="$options\n  Keybindings"
  options="$options\n  Config"

  case $(hyprdev-rofi-menu "$options") in
  *Audio*) kitty --class "audio" -e wiremix ;;
  *Wifi*) kitty --class "network" -e env -u COLORTERM TERM=xterm-old nmtui ;;
  *Bluetooth*) hyprdev-show-bluetooth ;;
  *Monitors*) open_in_editor ~/.config/hypr/monitor.conf ;;
  *Wallpaper*) show_wallpaper_menu ;;
  *Keybindings*) open_in_editor ~/.config/hypr/keybinds.conf ;;
  *Config*) show_setup_config_menu ;;
  *) show_main_menu ;;
  esac
}

show_wallpaper_menu() {
  case $(hyprdev-rofi-menu "Next Wallpaper\nSelect Wallpaper\nToggle Diashow") in
  *Next*) hyprdev-exec-next-wallpaper ;;
  *Select*) hyprdev-select-wallpaper ;;
  *Diashow*) hyprdev-wallpaper-diashow --toggle ;;
  esac
}

show_setup_config_menu() {
  case $(hyprdev-rofi-menu "  Hyprland\n  Hypridle\n  Hyprlock\n  Hyprsunset\n  Swayosd\n󰍜  Waybar") in
  *Hyprland*) open_in_editor ~/.config/hypr/hyprland.conf ;;
  *Hypridle*) open_in_editor ~/.config/hypr/hypridle.conf && hyprdev-restart-app hypridle ;;
  *Hyprlock*) open_in_editor ~/.config/hypr/hyprlock.conf ;;
  *Hyprsunset*) open_in_editor ~/.config/hypr/hyprsunset.conf && hyprdev-restart-app hyprsunset ;;
  *Swayosd*) open_in_editor ~/.config/swayosd/config.toml && hyprdev-restart-app swayosd-server ;;
  *Waybar*) open_in_editor ~/.config/waybar/config.jsonc && hyprdev-reload-waybar ;;
  *) show_main_menu ;;
  esac
}

show_main_menu() {
  go_to_menu "$(hyprdev-rofi-menu "󰀻  Apps\n󱓞  Trigger\n  Setup\n󰉉  Install\n  System")"
}

go_to_menu() {
  case "${1,,}" in
  *apps*) hyprdev-launch-rofi ;;
  *trigger*) show_trigger_menu ;;
  *screenshot*) hyprdev-screenshot-with-edit ;;
  *screenrecord*) show_screenrecord_menu ;;
  *setup*) show_setup_menu ;;
  *install*) show_install_menu ;;
  *system*) hyprdev-powermenu ;;
  esac
}

if [[ -n "$1" ]]; then
  BACK_TO_EXIT=true
  go_to_menu "$1"
else
  show_main_menu
fi
